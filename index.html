<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è²¡å‹™æŒ‡æ¨™åˆ†æ RPG - Version 2.0</title>
  <style>
    :root{
      --border:#ddd; --border2:#ccc; --text-muted:#666;
      --ok:#0a7; --ng:#c33; --radius:14px;
      --asset-bg: #eef6ff; --asset-bd:#b7d7ff;
      --exp-bg:   #fff7e6; --exp-bd:#ffd08a;
      --other-bg: #f5f5f5; --other-bd:#d9d9d9;
    }
    body { font-family: sans-serif; max-width: 920px; margin: 24px auto; padding: 0 12px; background-color: #f9f9f9; color: #333; }
    .card { border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .muted { color: var(--text-muted); font-size: 14px; }
    .big { font-size: 28px; font-weight: 800; margin: 10px 0 20px; color: #000; text-align: center; }
    .status-bar { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; padding: 16px; border-radius: 12px; border: 2px solid #333; background: #fff; }
    .char-icon { font-size: 48px; }
    .formula-display { min-height: 60px; background: #f8f9fa; border: 2px inset #eee; border-radius: 10px; padding: 10px; display: flex; gap: 4px; flex-wrap: wrap; align-items: center; justify-content: center; margin-bottom: 10px; }
    .token { background: #fff; border: 1px solid #999; padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 14px; }
    .grid { display: grid; gap: 8px; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); margin-top: 20px; }
    .typeBtn { padding: 12px 4px; font-size: 13px; font-weight: 800; border-radius: 10px; border: 2px solid var(--border2); cursor: pointer; background: #fff; }
    .btn-bs { background-color: var(--asset-bg) !important; border-color: var(--asset-bd) !important; color: #004488; }
    .btn-pl { background-color: var(--exp-bg) !important; border-color: var(--exp-bd) !important; color: #884400; }
    .btn-op { background-color: var(--other-bg) !important; border-color: var(--other-bd) !important; }
    .actionBtn { padding: 10px 16px; font-weight: 700; border-radius: 10px; border: 1px solid var(--border2); background: #fff; cursor: pointer; }
    .submitBtn { padding: 12px 24px; font-size: 18px; font-weight: 900; border-radius: 10px; border: 2px solid #333; background: #333; color: #fff; cursor: pointer; flex: 1; }
    #result { text-align: center; font-size: 18px; font-weight: bold; min-height: 1.5em; margin-bottom: 5px; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal-card { background: #fff; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 500px; }
  </style>
</head>
<body>

<div id="startModal" class="modal">
  <div class="modal-card">
    <h2>åå‰ã‚’å…¥åŠ›ï¼ˆæ–°Verï¼‰</h2>
    <input type="text" id="initialNameInput" style="width:90%; padding:12px; font-size:18px; border:2px solid #ddd; border-radius:10px; margin-bottom:20px;">
    <button onclick="saveAndStart()" class="actionBtn" style="background:#333; color:#fff; width:100%; padding:14px;">åˆ†æé–‹å§‹</button>
  </div>
</div>

<div class="card">
  <div class="status-bar">
    <div class="char-icon" id="charIcon">ğŸ¥š</div>
    <div style="flex:1">
      <div id="displayName" style="font-weight:800; font-size:18px;">---</div>
      <div id="charLevelName" style="font-weight:800; color:#555;">Lv.1 åˆ†æã®ãŸã¾ã”</div>
    </div>
    <div style="text-align:right;">
      <div class="small">ç´¯è¨ˆæ­£è§£</div>
      <div style="font-weight:800; font-size:20px;"><span id="totalAccumulated">0</span>å•</div>
      <button onclick="resetEverything()" class="muted">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

  <div id="quizArea">
    <div id="qCat" class="muted" style="text-align:center;"></div>
    <div id="targetName" class="big">èª­ã¿è¾¼ã¿ä¸­...</div>
    <div id="formulaDisplay" class="formula-display"></div>
  </div>

  <div id="result"></div>

  <div style="display:flex; gap:8px; justify-content: center; margin-bottom: 15px; flex-wrap: wrap;">
    <button class="submitBtn" onclick="checkAnswerFinal()">å›ç­”ã™ã‚‹</button>
    <button class="actionBtn" onclick="undo()">1ã¤æ¶ˆã™</button>
    <button class="actionBtn" onclick="clearFormula()">å…¨éƒ¨æ¶ˆã™</button>
  </div>

  <div id="buttonArea" class="grid"></div>
</div>

<script>
  // ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã‚­ãƒ¼ã‚’ v2 ã«å¤‰æ›´ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å›é¿
  const DB_KEY_SCORE = 'ratioRPG_v2_score';
  const DB_KEY_NAME = 'ratioRPG_v2_name';

  const QUESTIONS = [
    { cat: "åç›Šæ€§", name: "å£²ä¸Šé«˜ç·åˆ©ç›Šç‡", formula: ["å£²ä¸Šç·åˆ©ç›Š", "Ã·", "å£²ä¸Šé«˜", "Ã—100"] },
    { cat: "åç›Šæ€§", name: "å£²ä¸Šé«˜å–¶æ¥­åˆ©ç›Šç‡", formula: ["å–¶æ¥­åˆ©ç›Š", "Ã·", "å£²ä¸Šé«˜", "Ã—100"] },
    { cat: "åç›Šæ€§", name: "å£²ä¸Šé«˜çµŒå¸¸åˆ©ç›Šç‡", formula: ["çµŒå¸¸åˆ©ç›Š", "Ã·", "å£²ä¸Šé«˜", "Ã—100"] },
    { cat: "åç›Šæ€§", name: "å£²ä¸Šé«˜å½“æœŸç´”åˆ©ç›Šç‡", formula: ["å½“æœŸç´”åˆ©ç›Š", "Ã·", "å£²ä¸Šé«˜", "Ã—100"] },
    { cat: "åç›Šæ€§", name: "ç·è³‡æœ¬åˆ©ç›Šç‡ï¼ˆROAï¼‰", formula: ["å½“æœŸç´”åˆ©ç›Š", "Ã·", "ç·è³‡æœ¬", "Ã—100"] },
    { cat: "åç›Šæ€§", name: "è‡ªå·±è³‡æœ¬åˆ©ç›Šç‡ï¼ˆROEï¼‰", formula: ["å½“æœŸç´”åˆ©ç›Š", "Ã·", "è‡ªå·±è³‡æœ¬", "Ã—100"] },
    { cat: "å®‰å…¨æ€§", name: "æµå‹•æ¯”ç‡", formula: ["æµå‹•è³‡ç”£", "Ã·", "æµå‹•è² å‚µ", "Ã—100"] },
    { cat: "å®‰å…¨æ€§", name: "å½“åº§æ¯”ç‡", formula: ["å½“åº§è³‡ç”£", "Ã·", "æµå‹•è² å‚µ", "Ã—100"] },
    { cat: "å®‰å…¨æ€§", name: "è² å‚µæ¯”ç‡", formula: ["è² å‚µ", "Ã·", "è‡ªå·±è³‡æœ¬", "Ã—100"] },
    { cat: "å®‰å…¨æ€§", name: "è‡ªå·±è³‡æœ¬æ¯”ç‡", formula: ["è‡ªå·±è³‡æœ¬", "Ã·", "ç·è³‡æœ¬", "Ã—100"] },
    { cat: "å®‰å…¨æ€§", name: "å›ºå®šæ¯”ç‡", formula: ["å›ºå®šè³‡ç”£", "Ã·", "è‡ªå·±è³‡æœ¬", "Ã—100"] },
    { cat: "å®‰å…¨æ€§", name: "å›ºå®šé•·æœŸé©åˆç‡", formula: ["å›ºå®šè³‡ç”£", "Ã·", "ï¼ˆ", "å›ºå®šè² å‚µ", "ï¼‹", "è‡ªå·±è³‡æœ¬", "ï¼‰", "Ã—100"] },
    { cat: "æˆé•·æ€§", name: "å£²ä¸Šé«˜æˆé•·ç‡", formula: ["ï¼ˆ", "å½“æœŸå£²ä¸Šé«˜", "ï¼", "å‰æœŸå£²ä¸Šé«˜", "ï¼‰", "Ã·", "å‰æœŸå£²ä¸Šé«˜", "Ã—100"] },
    { cat: "åŠ¹ç‡æ€§", name: "å£²ä¸ŠåŸä¾¡ç‡", formula: ["å£²ä¸ŠåŸä¾¡", "Ã·", "å£²ä¸Šé«˜", "Ã—100"] },
    { cat: "åŠ¹ç‡æ€§", name: "å£²ä¸Šå‚µæ¨©å›è»¢ç‡", formula: ["å£²ä¸Šé«˜", "Ã·", "ï¼ˆ", "å—å–æ‰‹å½¢", "ï¼‹", "å£²æ›é‡‘", "ï¼‰"] },
    { cat: "åŠ¹ç‡æ€§", name: "å•†å“å›è»¢ç‡", formula: ["å£²ä¸Šé«˜", "Ã·", "å•†å“"] },
    { cat: "åŠ¹ç‡æ€§", name: "ç·è³‡æœ¬å›è»¢ç‡", formula: ["å£²ä¸Šé«˜", "Ã·", "ç·è³‡æœ¬"] }
  ];

  const CHARACTERS = [
    { score: 0, icon: 'ğŸ¥š', name: 'Lv.1 åˆ†æã®ãŸã¾ã”' },
    { score: 20, icon: 'ğŸ£', name: 'Lv.2 åˆ†æãƒ”ãƒ¨ãƒ”ãƒ¨' },
    { score: 500, icon: 'ğŸ²', name: 'Lv.10 ä¼èª¬ã®è§£æé¾' },
    { score: 1000, icon: 'ğŸ‘‘', name: 'Lv.MAX è²¡å‹™ã®æ”¯é…è€…' }
  ];

  let state = { totalCorrect: 0, currentIdx: 0, inputTokens: [] };

  // â˜…ã€æœ€é‡è¦ã€‘ã“ã“ãŒãƒœã‚¿ãƒ³ã®ä¸¦ã³é †ã§ã™ï¼
  function forceGenerateButtons() {
    const plItems = ["å£²ä¸Šé«˜", "å‰æœŸå£²ä¸Šé«˜", "å½“æœŸå£²ä¸Šé«˜", "å£²ä¸ŠåŸä¾¡", "å£²ä¸Šç·åˆ©ç›Š" ,"å–¶æ¥­åˆ©ç›Š", "çµŒå¸¸åˆ©ç›Š", "å½“æœŸç´”åˆ©ç›Š"];
    const bsItems = ["æµå‹•è³‡ç”£", "å½“åº§è³‡ç”£", "å›ºå®šè³‡ç”£", "å—å–æ‰‹å½¢", "å£²æ›é‡‘", "å•†å“", "è² å‚µ", "æµå‹•è² å‚µ", "å›ºå®šè² å‚µ", "è‡ªå·±è³‡æœ¬", "ç·è³‡æœ¬"];
    const ops = ["ï¼‹", "ï¼", "Ã·", "ï¼ˆ", "ï¼‰", "Ã—100"];
    
    const container = document.getElementById('buttonArea');
    container.innerHTML = "";

    // é…åˆ—ã®é †ç•ªé€šã‚Šã«1ã¤ãšã¤ä½œæˆï¼ˆsortã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ï¼‰
    plItems.forEach(t => createBtn(t, 'btn-pl', container));
    bsItems.forEach(t => createBtn(t, 'btn-bs', container));
    ops.forEach(t => createBtn(t, 'btn-op', container));
  }

  function createBtn(text, cls, container) {
    const btn = document.createElement('button');
    btn.className = 'typeBtn ' + cls;
    btn.textContent = text;
    btn.onclick = () => { state.inputTokens.push(text); renderFormula(); };
    container.appendChild(btn);
  }

  function init() {
    const savedName = localStorage.getItem(DB_KEY_NAME);
    if (!savedName) {
      document.getElementById('startModal').style.display = 'flex';
    } else {
      state.totalCorrect = parseInt(localStorage.getItem(DB_KEY_SCORE) || 0);
      document.getElementById('displayName').textContent = savedName + " æ®¿";
      forceGenerateButtons(); // é †ç•ªé€šã‚Šã«ç”Ÿæˆ
      nextQuestion();
      updateUI();
    }
  }

  function saveAndStart() {
    const val = document.getElementById('initialNameInput').value.trim();
    if (!val) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    localStorage.setItem(DB_KEY_NAME, val);
    location.reload();
  }

  function renderFormula() {
    const disp = document.getElementById('formulaDisplay');
    disp.innerHTML = state.inputTokens.map(t => `<span class="token">${t}</span>`).join('');
  }

  function checkAnswerFinal() {
    if (state.inputTokens.length === 0) return;
    const target = QUESTIONS[state.currentIdx].formula;
    const isCorrect = JSON.stringify(state.inputTokens) === JSON.stringify(target);
    const resEl = document.getElementById('result');
    if (isCorrect) {
      resEl.innerHTML = '<span style="color:var(--ok);">â­• æ­£è§£ï¼</span>';
      state.totalCorrect++;
      localStorage.setItem(DB_KEY_SCORE, state.totalCorrect);
      setTimeout(nextQuestion, 1000);
    } else {
      resEl.innerHTML = '<span style="color:var(--ng);">âŒ ä¸æ­£è§£...</span>';
      setTimeout(() => { state.inputTokens = []; renderFormula(); resEl.innerHTML = ""; }, 2000);
    }
    updateUI();
  }

  function nextQuestion() {
    state.currentIdx = Math.floor(Math.random() * QUESTIONS.length);
    document.getElementById('qCat').textContent = "ã€”" + QUESTIONS[state.currentIdx].cat + "åˆ†æã€•";
    document.getElementById('targetName').textContent = QUESTIONS[state.currentIdx].name;
    state.inputTokens = []; renderFormula();
  }

  function clearFormula() { state.inputTokens = []; renderFormula(); }
  function undo() { state.inputTokens.pop(); renderFormula(); }
  function resetEverything() { localStorage.clear(); location.reload(); }

  function updateUI() {
    document.getElementById('totalAccumulated').textContent = state.totalCorrect;
    let chara = CHARACTERS[0];
    for (let c of CHARACTERS) { if (state.totalCorrect >= c.score) chara = c; }
    document.getElementById('charIcon').textContent = chara.icon;
    document.getElementById('charLevelName').textContent = chara.name;
  }

  window.onload = init;
</script>
</body>
</html>
