<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è²¡å‹™è«¸è¡¨åˆ†ææŒ‡æ¨™ RPG - Final Edition</title>
  <style>
    :root{
      --border:#ddd; --border2:#ccc; --text-muted:#666;
      --ok:#0a7; --ng:#c33; --radius:14px;
      --asset-bg: #eef6ff; --asset-bd:#b7d7ff;
      --exp-bg:   #fff7e6; --exp-bd:#ffd08a;
      --other-bg: #f5f5f5; --other-bd:#d9d9d9;
    }

    body { font-family: sans-serif; max-width: 920px; margin: 24px auto; padding: 0 12px; background-color: #f9f9f9; color: #333; }
    .card { border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: relative; }
    .muted { color: var(--text-muted); font-size: 14px; }
    .big { font-size: 28px; font-weight: 800; margin: 10px 0 20px; color: #000; text-align: center; line-height: 1.2; }
    
    .status-bar { 
      display: flex; align-items: center; gap: 16px; 
      margin-bottom: 20px; padding: 16px; border-radius: 12px;
      border: 2px solid #333;
      background: linear-gradient(270deg, #ffe6e6, #e6f0ff, #e6ffe6, #fffde6);
      background-size: 800% 800%;
      animation: bgAnimation 15s ease infinite;
    }
    @keyframes bgAnimation { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    .char-icon { font-size: 48px; line-height: 1; animation: bounce 2s infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

    .formula-display {
      min-height: 60px; background: #f8f9fa; border: 2px inset #eee; border-radius: 10px;
      padding: 10px; display: flex; gap: 4px; flex-wrap: wrap; align-items: center; justify-content: center; margin-bottom: 10px;
    }
    .token { background: #fff; border: 1px solid #999; padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

    .grid { display: grid; gap: 8px; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); margin-top: 20px; }
    .typeBtn { padding: 12px 4px; font-size: 13px; font-weight: 800; border-radius: 10px; border: 2px solid var(--border2); cursor: pointer; background: #fff; transition: 0.1s; line-height: 1.2; }
    .typeBtn:active { transform: translateY(2px); filter: brightness(0.9); }
    
    .btn-bs { background-color: var(--asset-bg) !important; border-color: var(--asset-bd) !important; color: #004488; }
    .btn-pl { background-color: var(--exp-bg) !important; border-color: var(--exp-bd) !important; color: #884400; }
    .btn-op { background-color: var(--other-bg) !important; border-color: var(--other-bd) !important; }

    .actionBtn { padding: 10px 16px; font-weight: 700; border-radius: 10px; border: 1px solid var(--border2); background: #fff; cursor: pointer; }
    .submitBtn { padding: 12px 24px; font-size: 18px; font-weight: 900; border-radius: 10px; border: 2px solid #333; background: #333; color: #fff; cursor: pointer; flex: 1; }
    .submitBtn:hover { background: #000; }

    #result { text-align: center; font-size: 18px; font-weight: bold; min-height: 1.5em; margin-bottom: 5px; }

    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal-card { background: #fff; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 500px; }
    .mistake-item { text-align: left; padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
  </style>
</head>
<body>

<div id="startModal" class="modal">
  <div class="modal-card">
    <h2>åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
    <input type="text" id="initialNameInput" style="width:90%; padding:12px; font-size:18px; border:2px solid #ddd; border-radius:10px; margin-bottom:20px;">
    <button onclick="saveAndStart()" class="actionBtn" style="background:#333; color:#fff; width:100%; padding:14px;">åˆ†æé–‹å§‹</button>
  </div>
</div>

<div id="mistakeModal" class="modal">
  <div class="modal-card">
    <h3>ğŸ“ è‹¦æ‰‹ãªæŒ‡æ¨™ãƒªã‚¹ãƒˆ</h3>
    <div id="mistakeListArea" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;"></div>
    <button onclick="closeMistake()" class="actionBtn">é–‰ã˜ã‚‹</button>
  </div>
</div>

<div class="card">
  <div class="status-bar">
    <div class="char-icon" id="charIcon">ğŸ¥š</div>
    <div style="flex:1">
      <div id="displayName" style="font-weight:800; font-size:18px;">---</div>
      <div id="charLevelName" style="font-weight:800; color:#555;">Lv.1 åˆ†æã®ãŸã¾ã”</div>
      <div id="charNext" class="muted" style="font-size:11px;"></div>
    </div>
    <div style="text-align:right;">
      <div class="small">ç´¯è¨ˆæ­£è§£</div>
      <div style="font-weight:800; font-size:20px;"><span id="totalAccumulated">0</span>å•</div>
      <button onclick="resetEverything()" class="muted" style="background:none; border:none; text-decoration:underline; cursor:pointer; padding:0; font-size:11px;">åå‰ã‚’å¤‰æ›´ãƒ»ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

  <div id="quizArea">
    <div id="qCat" class="muted" style="text-align:center; font-weight: bold; color: var(--ok);"></div>
    <div id="targetName" class="big">èª­ã¿è¾¼ã¿ä¸­...</div>
    <div id="formulaDisplay" class="formula-display"></div>
  </div>

  <div id="result"></div>

  <div style="display:flex; gap:8px; justify-content: center; margin-bottom: 15px; flex-wrap: wrap;">
    <button class="submitBtn" onclick="checkAnswerFinal()">å›ç­”ã™ã‚‹</button>
    <button class="actionBtn" onclick="undo()">1ã¤æ¶ˆã™</button>
    <button class="actionBtn" onclick="clearFormula()" style="color:var(--ng);">å…¨éƒ¨æ¶ˆã™</button>
    <button class="actionBtn" onclick="skipQuestion()" style="color:var(--text-muted);">ã‚¹ã‚­ãƒƒãƒ—</button>
    <button id="mistakeBtn" class="actionBtn" onclick="openMistake()" style="display:none; background:#fff5f5; border-color:var(--ng); color:var(--ng);">è‹¦æ‰‹ãƒªã‚¹ãƒˆ (<span id="mCount">0</span>)</button>
  </div>

  <div id="buttons" class="grid"></div>

  <div class="muted" style="border-top:1px solid #eee; margin-top:20px; padding-top:12px; display:flex; justify-content:space-between;">
    <span>ä»Šå›ï¼š<span id="sessionScore">0</span> / <span id="sessionTotal">0</span> å•æ­£è§£</span>
    <span>æ­£è§£ç‡: <span id="accuracy">0</span>%</span>
  </div>
</div>

<script>
  const QUESTIONS = [
    { cat: "åç›Šæ€§", name: "å£²ä¸Šé«˜ç·åˆ©ç›Šç‡", formula: ["å£²ä¸Šç·åˆ©ç›Š", "Ã·", "å£²ä¸Šé«˜", "Ã—100"] },
    { cat: "åç›Šæ€§", name: "å£²ä¸Šé«˜å–¶æ¥­åˆ©ç›Šç‡", formula: ["å–¶æ¥­åˆ©ç›Š", "Ã·", "å£²ä¸Šé«˜", "Ã—100"] },
    { cat: "åç›Šæ€§", name: "å£²ä¸Šé«˜çµŒå¸¸åˆ©ç›Šç‡", formula: ["çµŒå¸¸åˆ©ç›Š", "Ã·", "å£²ä¸Šé«˜", "Ã—100"] },
    { cat: "åç›Šæ€§", name: "å£²ä¸Šé«˜å½“æœŸç´”åˆ©ç›Šç‡", formula: ["å½“æœŸç´”åˆ©ç›Š", "Ã·", "å£²ä¸Šé«˜", "Ã—100"] },
    { cat: "åç›Šæ€§", name: "ç·è³‡æœ¬åˆ©ç›Šç‡ï¼ˆROAï¼‰", formula: ["å½“æœŸç´”åˆ©ç›Š", "Ã·", "ç·è³‡æœ¬", "Ã—100"] },
    { cat: "åç›Šæ€§", name: "è‡ªå·±è³‡æœ¬åˆ©ç›Šç‡ï¼ˆROEï¼‰", formula: ["å½“æœŸç´”åˆ©ç›Š", "Ã·", "è‡ªå·±è³‡æœ¬", "Ã—100"] },
    { cat: "å®‰å…¨æ€§", name: "æµå‹•æ¯”ç‡", formula: ["æµå‹•è³‡ç”£", "Ã·", "æµå‹•è² å‚µ", "Ã—100"] },
    { cat: "å®‰å…¨æ€§", name: "å½“åº§æ¯”ç‡", formula: ["å½“åº§è³‡ç”£", "Ã·", "æµå‹•è² å‚µ", "Ã—100"] },
    { cat: "å®‰å…¨æ€§", name: "è² å‚µæ¯”ç‡", formula: ["è² å‚µ", "Ã·", "è‡ªå·±è³‡æœ¬", "Ã—100"] },
    { cat: "å®‰å…¨æ€§", name: "è‡ªå·±è³‡æœ¬æ¯”ç‡", formula: ["è‡ªå·±è³‡æœ¬", "Ã·", "ç·è³‡æœ¬", "Ã—100"] },
    { cat: "å®‰å…¨æ€§", name: "å›ºå®šæ¯”ç‡", formula: ["å›ºå®šè³‡ç”£", "Ã·", "è‡ªå·±è³‡æœ¬", "Ã—100"] },
    { cat: "å®‰å…¨æ€§", name: "å›ºå®šé•·æœŸé©åˆç‡", formula: ["å›ºå®šè³‡ç”£", "Ã·", "ï¼ˆ", "å›ºå®šè² å‚µ", "ï¼‹", "è‡ªå·±è³‡æœ¬", "ï¼‰", "Ã—100"] },
    { cat: "æˆé•·æ€§", name: "å£²ä¸Šé«˜æˆé•·ç‡", formula: ["ï¼ˆ", "å½“æœŸå£²ä¸Šé«˜", "ï¼", "å‰æœŸå£²ä¸Šé«˜", "ï¼‰", "Ã·", "å‰æœŸå£²ä¸Šé«˜", "Ã—100"] },
    { cat: "åŠ¹ç‡æ€§", name: "å£²ä¸ŠåŸä¾¡ç‡", formula: ["å£²ä¸ŠåŸä¾¡", "Ã·", "å£²ä¸Šé«˜", "Ã—100"] },
    { cat: "åŠ¹ç‡æ€§", name: "å£²ä¸Šå‚µæ¨©å›è»¢ç‡", formula: ["å£²ä¸Šé«˜", "Ã·", "ï¼ˆ", "å—å–æ‰‹å½¢", "ï¼‹", "å£²æ›é‡‘", "ï¼‰"] },
    { cat: "åŠ¹ç‡æ€§", name: "å•†å“å›è»¢ç‡", formula: ["å£²ä¸ŠåŸä¾¡", "Ã·", "å•†å“"] },
    { cat: "åŠ¹ç‡æ€§", name: "ç·è³‡æœ¬å›è»¢ç‡", formula: ["å£²ä¸Šé«˜", "Ã·", "ç·è³‡æœ¬"] }
  ];

  const CHARACTERS = [
    { score: 0,   icon: 'ğŸ¥š', name: 'Lv.1 åˆ†æã®ãŸã¾ã”' },
    { score: 20,   icon: 'ğŸ£', name: 'Lv.2 åˆ†æãƒ”ãƒ¨ãƒ”ãƒ¨' },
    { score: 40,  icon: 'ğŸ¥', name: 'Lv.3 ã‹ã‘ã ã—åˆ†æå®˜' },
    { score: 60,  icon: 'ğŸ¤', name: 'Lv.4 è¦‹ç¿’ã„èª¿æŸ»å“¡' },
    { score: 80,  icon: 'ğŸ¦‰', name: 'Lv.5 è²¡å‹™ã®è³¢è€…' },
    { score: 100,  icon: 'ğŸ“œ', name: 'Lv.6 åˆ†æã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ' },
    { score: 140,  icon: 'ğŸ’', name: 'Lv.7 è²¡å‹™ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ã‚¹ãƒˆ' },
    { score: 180,  icon: 'ğŸ¦…', name: 'Lv.8 è’¼å¤©ã®è§£æè€…' },
    { score: 250, icon: 'ğŸŒŸ', name: 'Lv.9 è–åŸŸã®ä¼šè¨ˆå£«' },
    { score: 500, icon: 'ğŸ²', name: 'Lv.10 ä¼èª¬ã®è§£æé¾' },
    { score: 1000, icon: 'ğŸ‘‘', name: 'Lv.MAX è²¡å‹™ã®æ”¯é…è€…' }
  ];

  let state = { name: "", totalCorrect: 0, currentIdx: 0, inputTokens: [], sessionCorrect: 0, sessionTotal: 0, mistakes: [] };

  function init() {
    const savedName = localStorage.getItem('ratioRPG_name');
    if (!savedName) { 
        document.getElementById('startModal').style.display = 'flex'; 
    } else {
        state.name = savedName;
        state.totalCorrect = parseInt(localStorage.getItem('ratioRPG_score') || 0);
        state.mistakes = JSON.parse(localStorage.getItem('ratioRPG_mistakes') || "[]");
        document.getElementById('displayName').textContent = state.name + " æ®¿";
        generateButtons(); // é–¢æ•°åã‚’æ–°ã—ã„ã‚‚ã®ã«å¤‰æ›´
        nextQuestion(); 
        updateUI();
    }
  }

  function saveAndStart() {
    const val = document.getElementById('initialNameInput').value.trim();
    if (!val) return alert("åå‰ã‚’å…¥ã‚Œã¦ãã ã•ã„");
    localStorage.clear();
    state.name = val;
    localStorage.setItem('ratioRPG_name', val);
    location.reload();
  }

  function resetEverything() {
    if (confirm("åå‰ã‚„ã“ã‚Œã¾ã§ã®è¨˜éŒ²ã¯å…¨ã¦ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) { 
        localStorage.clear(); 
        location.reload(); 
    }
  }

  // â˜…ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–ã¨ã—ã¦é–¢æ•°åã‚’ buildButtons ã‹ã‚‰å¤‰æ›´â˜…
  function generateButtons() {
    // ã“ã®é…åˆ—ã«æ›¸ã„ãŸé€šã‚Šã®é †ç•ªã§ç”»é¢ã«ä¸¦ã³ã¾ã™
    const plItems = ["å£²ä¸Šé«˜", "å‰æœŸå£²ä¸Šé«˜", "å½“æœŸå£²ä¸Šé«˜", "å£²ä¸ŠåŸä¾¡", "å£²ä¸Šç·åˆ©ç›Š" ,"å–¶æ¥­åˆ©ç›Š", "çµŒå¸¸åˆ©ç›Š", "å½“æœŸç´”åˆ©ç›Š"];
    const bsItems = ["æµå‹•è³‡ç”£", "å½“åº§è³‡ç”£", "å›ºå®šè³‡ç”£", "å—å–æ‰‹å½¢", "å£²æ›é‡‘", "å•†å“", "è² å‚µ", "æµå‹•è² å‚µ", "å›ºå®šè² å‚µ", "è‡ªå·±è³‡æœ¬", "ç·è³‡æœ¬"];
    const ops = ["ï¼‹", "ï¼", "Ã·", "ï¼ˆ", "ï¼‰", "Ã—100"];
    
    const container = document.getElementById('buttons');
    container.innerHTML = "";

    // .sort() ã‚’å®Œå…¨ã«æ’é™¤ã—ã€é…åˆ—ã®é †ç•ªã§ãƒœã‚¿ãƒ³ã‚’ä½œæˆã—ã¾ã™
    plItems.forEach(text => createBtn(text, 'btn-pl', container));
    bsItems.forEach(text => createBtn(text, 'btn-bs', container));
    ops.forEach(text => createBtn(text, 'btn-op', container));
  }

  function createBtn(text, cls, container) {
    const btn = document.createElement('button');
    btn.className = 'typeBtn ' + cls;
    btn.textContent = text;
    btn.onclick = () => { state.inputTokens.push(text); renderFormula(); };
    container.appendChild(btn);
  }

  function renderFormula() {
    const disp = document.getElementById('formulaDisplay');
    disp.innerHTML = state.inputTokens.map(t => `<span class="token">${t}</span>`).join('');
    document.getElementById('result').innerHTML = ""; 
  }

  function checkAnswerFinal() {
    if (state.inputTokens.length === 0) return;
    const target = QUESTIONS[state.currentIdx].formula;
    const isCorrect = JSON.stringify(state.inputTokens) === JSON.stringify(target);
    const resEl = document.getElementById('result');
    if (isCorrect) {
      resEl.innerHTML = '<span style="color:var(--ok);">â­• æ­£è§£ï¼ç´ æ™´ã‚‰ã—ã„ï¼</span>';
      state.totalCorrect++; state.sessionCorrect++; state.sessionTotal++;
      localStorage.setItem('ratioRPG_score', state.totalCorrect);
      setTimeout(nextQuestion, 1000);
    } else {
      resEl.innerHTML = '<span style="color:var(--ng);">âŒ ä¸æ­£è§£... æ­£è§£ã‚’ç¢ºèªã—ã¦ãã ã•ã„</span>';
      addMistake(QUESTIONS[state.currentIdx]);
      state.sessionTotal++;
      setTimeout(() => { if(resEl.innerText.includes("ä¸æ­£è§£")) { state.inputTokens = []; renderFormula(); resEl.innerHTML = ""; } }, 2000);
    }
    updateUI();
  }

  function nextQuestion() {
    state.currentIdx = Math.floor(Math.random() * QUESTIONS.length);
    document.getElementById('qCat').textContent = "ã€”" + QUESTIONS[state.currentIdx].cat + "åˆ†æã€•";
    document.getElementById('targetName').textContent = QUESTIONS[state.currentIdx].name;
    document.getElementById('result').innerHTML = "";
    state.inputTokens = []; renderFormula();
  }

  function skipQuestion() { if(confirm("ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã‹ï¼Ÿ")) nextQuestion(); }
  function clearFormula() { state.inputTokens = []; renderFormula(); }
  function undo() { state.inputTokens.pop(); renderFormula(); }

  function addMistake(q) {
    if(!state.mistakes.some(m => m.name === q.name)) {
      state.mistakes.push(q);
      localStorage.setItem('ratioRPG_mistakes', JSON.stringify(state.mistakes));
    }
  }

  function openMistake() {
    const area = document.getElementById('mistakeListArea');
    area.innerHTML = state.mistakes.map(m => `
      <div class="mistake-item">
        <div><b>${m.name}</b><br><small>æ­£è§£: ${m.formula.join("")}</small></div>
        <button onclick="removeMistake('${m.name}')" style="font-size:10px;">å…‹æœ</button>
      </div>
    `).join('') || "ã¾ã ã‚ã‚Šã¾ã›ã‚“";
    document.getElementById('mistakeModal').style.display = 'flex';
  }

  function closeMistake() { document.getElementById('mistakeModal').style.display = 'none'; }
  function removeMistake(name) {
    state.mistakes = state.mistakes.filter(m => m.name !== name);
    localStorage.setItem('ratioRPG_mistakes', JSON.stringify(state.mistakes));
    openMistake(); updateUI();
  }

  function updateUI() {
    document.getElementById('totalAccumulated').textContent = state.totalCorrect;
    document.getElementById('sessionScore').textContent = state.sessionCorrect;
    document.getElementById('sessionTotal').textContent = state.sessionTotal;
    document.getElementById('accuracy').textContent = state.sessionTotal ? Math.round(state.sessionCorrect/state.sessionTotal*100) : 0;
    document.getElementById('mCount').textContent = state.mistakes.length;
    document.getElementById('mistakeBtn').style.display = state.mistakes.length > 0 ? "inline-block" : "none";

    let chara = CHARACTERS[0];
    for (let c of CHARACTERS) { if (state.totalCorrect >= c.score) chara = c; }
    document.getElementById('charIcon').textContent = chara.icon;
    document.getElementById('charLevelName').textContent = chara.name;
    const idx = CHARACTERS.indexOf(chara);
    document.getElementById('charNext').textContent = idx < CHARACTERS.length - 1 ? `ã‚ã¨ ${CHARACTERS[idx+1].score - state.totalCorrect} å•ã§é€²åŒ–` : "â˜… ç§°å·: MASTER â˜…";
  }

  // èµ·å‹•æ™‚ã«æ–°ã—ã„é–¢æ•°ã‚’å‘¼ã¶
  init();
</script>
</body>
</html>
